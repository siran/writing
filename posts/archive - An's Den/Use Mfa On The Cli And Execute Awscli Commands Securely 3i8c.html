<meta charset="utf-8">
<a class="image-link image2" target="_blank" href="https://postimg.cc/PCHc8xhN" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!fOls!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 424w, https://substackcdn.com/image/fetch/$s_!fOls!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 848w, https://substackcdn.com/image/fetch/$s_!fOls!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!fOls!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/e8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/e8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:null,&quot;width&quot;:null,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;u-https-insidesmallbusiness-com-au-wp-content-uploads-2019-03.jpg&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:&quot;https://postimg.cc/PCHc8xhN&quot;,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="u-https-insidesmallbusiness-com-au-wp-content-uploads-2019-03.jpg" title="u-https-insidesmallbusiness-com-au-wp-content-uploads-2019-03.jpg" srcset="https://substackcdn.com/image/fetch/$s_!fOls!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 424w, https://substackcdn.com/image/fetch/$s_!fOls!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 848w, https://substackcdn.com/image/fetch/$s_!fOls!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!fOls!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8ef0385-c1b1-4602-9a9d-8a1af77a61d3_900x636.jpeg 1456w" sizes="100vw" fetchpriority="high"></picture><div></div></div></a><p>To enhance security, you can enable multi-factor authenticantion (MFA) use also for issuing CLI commands. Manually obtaining the temporary tokens and setting them up as environment variables can be a hassle. I came up with this quick script to automate the job.</p><p>In the following script, you only have to replace <code>YOUR_MFA_ARN</code> with the MFA device you have configured in you security settings in your AWS IAM user.</p><p>Then you can either <code>source</code> or <code>execute</code> the script.</p><p><a href="https://gist.github.com/siran/0979d1f9aeaa16e7fa7162e16ded6f19">Hereâ€™s the bash script <code>aws-mfa-cli.sh</code> </a>:</p><pre><code># !/bin/bash
set -e

# check if script has been sourced or executed
(return 0 2&gt;/dev/null) &amp;&amp; sourced=1 || sourced=0

MFA_DEVICE_ARN=YOUR_MFA_ARN

read -p "Please enter you MFA code: " MFA_CODE

echo "You entered '$MFA_CODE'"

echo aws --output text sts get-session-token \
    --serial-number arn:aws:iam::661095214357:mfa/anmichel.rodriguez@annalect.com \
    --token-code $MFA_CODE

CREDS=$(aws --output text sts get-session-token \
    --serial-number $MFA_DEVICE_ARN \
    --token-code $MFA_CODE)

echo $CREDS

KEY=$(echo $CREDS | cut -d" " -f2)
SECRET=$(echo $CREDS | cut -d" " -f4)
SESS_TOKEN=$(echo $CREDS | cut -d" " -f5)

echo "Key: $KEY"
echo "Secret: $SECRET"
echo "Session token: $SESS_TOKEN"

export AWS_ACCESS_KEY_ID=$KEY
export AWS_SECRET_ACCESS_KEY=$SECRET
export AWS_SESSION_TOKEN=$SESS_TOKEN

if [ $sourced -eq 1 ]; then
    echo "Script was sourced."
else
    echo "Script was executed, starting subshell."
    bash -l
fi
</code></pre><p><em><a href="https://dev.to/michrodz/use-mfa-on-the-cli-and-execute-awscli-commands-securely-3i8c">This post is also available on DEV.</a></em></p>